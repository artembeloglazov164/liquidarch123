# Установка AUR пакетов в macOS Arch

## Проблема

При установке AUR пакетов могут возникать проблемы:
- Циклические зависимости
- Конфликты пакетов
- Ошибки сборки
- Проблемы с GPG ключами

## Решение

### LITE режим (первый запуск)

Скрипт `first-boot-setup.sh` устанавливает AUR пакеты с улучшенной обработкой ошибок:

#### Флаги установки:
```bash
yay -S --noconfirm \
  --needed \              # Не переустанавливать уже установленные
  --removemake \          # Удалить зависимости сборки после установки
  --cleanafter \          # Очистить кэш после установки
  --answerdiff=None \     # Не показывать diff файлов
  --answerclean=None \    # Не спрашивать об очистке
  --mflags "--nocheck --skippgpcheck"  # Пропустить проверки
```

#### Обработка ошибок:

1. **Первая попытка:** Установка с зависимостями
2. **Вторая попытка:** Установка без зависимостей (`--nodeps`)
3. **Проверка:** Проверка установленных пакетов через `pacman -Qi`

#### Приоритеты пакетов:

**Критичные (обязательные):**
- `latte-dock` - панель внизу
- `calamares` - установщик системы

**Опциональные (можно пропустить):**
- `whitesur-icon-theme-git` - иконки
- `whitesur-cursors-git` - курсоры

### FULL режим (при сборке ISO)

Аналогичная логика, но выполняется во время сборки ISO.

## Проверка установленных пакетов

После установки скрипт проверяет каждый пакет:

```bash
if pacman -Qi latte-dock &>/dev/null; then
    echo "✅ Latte Dock установлен"
else
    echo "❌ Latte Dock НЕ установлен"
fi
```

## Применение тем

Темы применяются только если пакеты установлены:

```bash
# Проверка установки
if pacman -Qi whitesur-icon-theme-git &>/dev/null; then
    # Применение иконок
    echo "Theme=WhiteSur-dark" >> ~/.config/kdeglobals
else
    # Использование стандартных иконок
    echo "⚠️  Используются стандартные иконки"
fi
```

## Ручная установка

Если пакет не установился автоматически:

```bash
# Установка вручную
yay -S latte-dock
yay -S calamares
yay -S whitesur-icon-theme-git
yay -S whitesur-cursors-git
```

## Логи установки

Логи сохраняются в `/tmp/install-<package>.log`:

```bash
# Просмотр логов
cat /tmp/install-latte-dock.log
cat /tmp/install-calamares.log
```

## Решение проблем

### Циклические зависимости

Если пакет не устанавливается из-за зависимостей:

```bash
# Установка без зависимостей
yay -S --nodeps latte-dock
```

### Ошибки GPG

Если ошибки с GPG ключами:

```bash
# Установка с пропуском проверки GPG
yay -S --mflags "--skippgpcheck" latte-dock
```

### Ошибки сборки

Если ошибки при сборке:

```bash
# Установка с пропуском тестов
yay -S --mflags "--nocheck" latte-dock
```

### Конфликты пакетов

Если конфликты с другими пакетами:

```bash
# Удаление конфликтующего пакета
sudo pacman -R conflicting-package

# Установка нужного пакета
yay -S latte-dock
```

## Альтернативы

Если AUR пакет не устанавливается, можно использовать альтернативы:

### Вместо Latte Dock:
- Стандартная панель KDE Plasma
- `plank` (из официальных репозиториев)

### Вместо Calamares:
- Ручная установка через `archinstall`
- Установка через терминал

### Вместо WhiteSur тем:
- Стандартные темы KDE
- Другие темы из официальных репозиториев

## Статистика установки

После установки показывается статистика:

```
Установлено пакетов: 3/4
✅ Latte Dock установлен
✅ Calamares установлен
✅ WhiteSur Icons установлены
⚠️  WhiteSur Cursors не установлены (опционально)
```

## Рекомендации

1. **Используйте LITE режим** - более стабильный
2. **Проверяйте интернет** перед первым запуском
3. **Подождите 10-15 минут** для установки всех пакетов
4. **Не прерывайте процесс** установки
5. **Проверяйте логи** если что-то пошло не так

## Известные проблемы

### Calamares
- Может не установиться из-за зависимостей от Qt
- Решение: установка без зависимостей или ручная установка

### WhiteSur темы
- Большой размер (долгая загрузка)
- Решение: пропустить установку, использовать стандартные темы

### Latte Dock
- Зависимости от KDE Frameworks
- Решение: обычно устанавливается без проблем

## Отладка

Включить подробный вывод:

```bash
# В скрипте first-boot-setup.sh
set -x  # Включить отладку
```

Проверить доступность пакетов:

```bash
# Поиск пакета в AUR
yay -Ss latte-dock
```

Проверить зависимости:

```bash
# Информация о пакете
yay -Si latte-dock
```
