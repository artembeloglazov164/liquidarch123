name: Build 320kgpenguin ISO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        df -h
        rm -rf /usr/share/dotnet || true
        rm -rf /opt/ghc || true
        rm -rf /usr/local/share/boost || true
        rm -rf /usr/local/lib/android || true
        df -h
    
    - name: Update system and install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm archiso git base-devel
    
    - name: Build ISO
      run: |
        cd build
        chmod +x build.sh
        bash build.sh
    
    - name: Get ISO info
      id: iso
      run: |
        ISO_FILE=$(ls out/*.iso | head -n 1)
        ISO_NAME=$(basename $ISO_FILE)
        ISO_SIZE=$(du -h $ISO_FILE | cut -f1)
        echo "filename=$ISO_FILE" >> $GITHUB_OUTPUT
        echo "basename=$ISO_NAME" >> $GITHUB_OUTPUT
        echo "size=$ISO_SIZE" >> $GITHUB_OUTPUT
    
    - name: Upload ISO as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 320kgpenguin-iso
        path: out/*.iso
        retention-days: 7
        compression-level: 0
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: 320kgpenguin v${{ github.run_number }}
        body: |
          üêß **320kgpenguin (macOS Liquid Arch)**
          
          –ö–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ Arch Linux —Å –¥–∏–∑–∞–π–Ω–æ–º macOS –∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –∂–∏–¥–∫–æ–≥–æ —Å—Ç–µ–∫–ª–∞.
          
          ## üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
          - **–§–∞–π–ª**: ${{ steps.iso.outputs.basename }}
          - **–†–∞–∑–º–µ—Ä**: ${{ steps.iso.outputs.size }}
          - **Build**: #${{ github.run_number }}
          - **Commit**: ${{ github.sha }}
          
          ## üçé –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
          - ‚ú® KDE Plasma —Å –∂–∏–¥–∫–∏–º —Å—Ç–µ–∫–ª–æ–º
          - üé® Latte Dock –≤–Ω–∏–∑—É —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º —É–≤–µ–ª–∏—á–µ–Ω–∏—è
          - üíø Calamares —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
          - ‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ macOS
          - üñ•Ô∏è 4 —Ä–∞–±–æ—á–∏—Ö —Å—Ç–æ–ª–∞
          - üåä Blur —ç—Ñ—Ñ–µ–∫—Ç—ã –≤–µ–∑–¥–µ
          - üéØ –¢–µ–º—ã macOS (fonts, wallpapers, plasmoids)
          
          ## üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          1. –°–∫–∞—á–∞–π—Ç–µ ISO —Ñ–∞–π–ª –Ω–∏–∂–µ
          2. –ó–∞–ø–∏—à–∏—Ç–µ –Ω–∞ USB: `sudo dd bs=4M if=*.iso of=/dev/sdX status=progress`
          3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ—Å—å —Å USB
          4. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º Calamares
          
          ## üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Live ISO
          - **liveuser** (–±–µ–∑ –ø–∞—Ä–æ–ª—è, –∞–≤—Ç–æ–ª–æ–≥–∏–Ω)
          - **root** (–±–µ–∑ –ø–∞—Ä–æ–ª—è)
          
          ## üöÄ –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          ```bash
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ yay
          sudo pacman -S --needed git base-devel
          git clone https://aur.archlinux.org/yay-bin.git
          cd yay-bin
          makepkg -si
          ```
          
          ---
          **–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π macOS –∏ Arch Linux**
        files: out/*.iso
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
