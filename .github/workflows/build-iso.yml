name: Build macOS Arch ISO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        echo "=== Disk space before cleanup ==="
        df -h
        echo "=== Removing unnecessary packages ==="
        rm -rf /usr/share/dotnet || true
        rm -rf /opt/ghc || true
        rm -rf /usr/local/share/boost || true
        rm -rf /usr/local/lib/android || true
        rm -rf /opt/hostedtoolcache || true
        rm -rf /usr/share/swift || true
        rm -rf /usr/local/.ghcup || true
        rm -rf /usr/local/share/powershell || true
        rm -rf /usr/local/share/chromium || true
        rm -rf /usr/local/lib/node_modules || true
        docker system prune -af || true
        echo "=== Disk space after cleanup ==="
        df -h
    
    - name: Update system and install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm archiso git base-devel
    
    - name: Build ISO
      run: |
        cd build
        chmod +x build.sh
        bash build.sh
    
    - name: Get ISO info
      id: iso
      run: |
        ISO_FILE=$(ls out/*.iso | head -n 1)
        ISO_NAME=$(basename $ISO_FILE)
        ISO_SIZE=$(du -h $ISO_FILE | cut -f1)
        echo "filename=$ISO_FILE" >> $GITHUB_OUTPUT
        echo "basename=$ISO_NAME" >> $GITHUB_OUTPUT
        echo "size=$ISO_SIZE" >> $GITHUB_OUTPUT
    
    - name: Upload ISO as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-arch-iso
        path: out/*.iso
        retention-days: 7
        compression-level: 0
    
    - name: Create Release Info
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ISO файл слишком большой для GitHub Releases (>2 ГБ)"
        echo "Скачайте ISO из Artifacts выше"
        echo ""
        echo "Информация о сборке:"
        echo "- Файл: ${{ steps.iso.outputs.basename }}"
        echo "- Размер: ${{ steps.iso.outputs.size }}"
        echo "- Build: #${{ github.run_number }}"
        echo "- Commit: ${{ github.sha }}"
