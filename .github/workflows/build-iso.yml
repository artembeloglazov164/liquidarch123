name: Build 320kgpenguin ISO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Update system and install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm archiso git base-devel sudo
    
    - name: Build ISO
      run: |
        cd build
        chmod +x build.sh
        bash build.sh
    
    - name: Get ISO filename
      id: iso
      run: |
        ISO_FILE=$(ls out/*.iso | head -n 1)
        echo "filename=$ISO_FILE" >> $GITHUB_OUTPUT
        echo "basename=$(basename $ISO_FILE)" >> $GITHUB_OUTPUT
    
    - name: Upload ISO as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 320kgpenguin-iso
        path: out/*.iso
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: 320kgpenguin v${{ github.run_number }}
        body: |
          üêß **320kgpenguin (macOS Liquid Arch)**
          
          –ö–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ Arch Linux —Å –¥–∏–∑–∞–π–Ω–æ–º macOS –∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –∂–∏–¥–∫–æ–≥–æ —Å—Ç–µ–∫–ª–∞.
          
          ## üçé –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
          - KDE Plasma —Å –∂–∏–¥–∫–∏–º —Å—Ç–µ–∫–ª–æ–º
          - Latte Dock –≤–Ω–∏–∑—É
          - Calamares —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
          - –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ macOS
          - 4 —Ä–∞–±–æ—á–∏—Ö —Å—Ç–æ–ª–∞
          - Blur —ç—Ñ—Ñ–µ–∫—Ç—ã –≤–µ–∑–¥–µ
          
          ## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          1. –°–∫–∞—á–∞–π—Ç–µ ISO —Ñ–∞–π–ª –Ω–∏–∂–µ
          2. –ó–∞–ø–∏—à–∏—Ç–µ –Ω–∞ USB: `sudo dd bs=4M if=*.iso of=/dev/sdX status=progress`
          3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ—Å—å —Å USB
          4. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º Calamares
          
          ## üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Live ISO
          - **liveuser** (–±–µ–∑ –ø–∞—Ä–æ–ª—è, –∞–≤—Ç–æ–ª–æ–≥–∏–Ω)
          - **root** (–±–µ–∑ –ø–∞—Ä–æ–ª—è)
          
          ---
          Build #${{ github.run_number }} | Commit: ${{ github.sha }}
        files: out/*.iso
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
